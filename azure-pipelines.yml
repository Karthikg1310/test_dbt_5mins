#YAML Script for DBT:

trigger:
- none

schedules:
- cron: '*/5 * * * *'
  displayName: 'Run Every 5 Minutes'
  branches:
    include:
    - 'main'
  always: true
  batch: false

jobs:
- job: RunDbtModels
  pool:
    vmImage: 'windows-latest'
  
  steps:
  - checkout: self

  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
      addToPath: true

 - powershell: |
      New-Item -ItemType Directory -Force -Path C:\dbt  # Create a directory for dbt
      Invoke-WebRequest -Uri https://bootstrap.pypa.io/get-pip.py -OutFile C:\dbt\get-pip.py
      python C:\dbt\get-pip.py  # Install pip
      pip install dbt
      pip install dbt-snowflake
    displayName: 'Install dbt and dependencies'

  - script: |
      dbt deps --profiles-dir $(Build.Repository.LocalPath)/dfz --project-dir $(Build.Repository.LocalPath)/dfz
    displayName: 'Install dbt dependencies'

  - script: |
      dbt run --profiles-dir $(Build.Repository.LocalPath)/dfz --project-dir $(Build.Repository.LocalPath)/dfz
    displayName: 'Run dbt models'

  - script: |
      dbt test --profiles-dir $(Build.Repository.LocalPath)/dfz --project-dir $(Build.Repository.LocalPath)/dfz
    displayName: 'Run dbt tests'
